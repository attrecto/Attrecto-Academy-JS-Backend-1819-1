#!/usr/bin/env node
const db = require('../db');

const createBadgesTable = async () => {
  const query = "CREATE TABLE `badges` ( \
    `id` bigint(20) NOT NULL AUTO_INCREMENT, \
    `name` varchar(255) NOT NULL, \
    `description` text, \
    PRIMARY KEY (`id`) \
  );";

  try {
    const connection = await db.connect();
    await db.query(connection, query);
    await db.close(connection);
  } catch (error) {
    throw error;
  }
};

const createUsersTable = async () => {
  const query = "CREATE TABLE `users` ( \
    `id` bigint(20) NOT NULL AUTO_INCREMENT, \
    `name` varchar(255) NOT NULL, \
    PRIMARY KEY (`id`) \
  );";

  try {
    const connection = await db.connect();
    await db.query(connection, query);
    await db.close(connection);
  } catch (error) {
    throw error;
  }
};

const createUsersBadgesTable = async () => {
  const query = "CREATE TABLE `users_badges` ( \
    `badge_id` bigint(20) NOT NULL, \
    `user_id` bigint(20) NOT NULL, \
    PRIMARY KEY (`user_id`,`badge_id`), \
    CONSTRAINT `users_badges_badges_FK` FOREIGN KEY (`badge_id`) REFERENCES `badges` (`id`) ON DELETE CASCADE, \
    CONSTRAINT `users_badges_users_FK` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE \
  );";

  try {
    const connection = await db.connect();
    await db.query(connection, query);
    await db.close(connection);
  } catch (error) {
    throw error;
  }
};

Promise.resolve()
  .then(() => createBadgesTable())
  .then(() => createUsersTable())
  .then(() => createUsersBadgesTable())
  .catch(e => console.log(e));

process.exit(0);